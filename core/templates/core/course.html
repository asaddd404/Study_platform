{% extends 'core/base.html' %}
{% block title %}Мой курс{% endblock %}

{% block content %}
<div class="course-layout" x-data="{ active: null }">

    <!-- ЛЕВАЯ ПАНЕЛЬ -->
    <aside class="course-sidebar">
        <div class="course-sidebar-header">
            <a href="{% url 'core:index' %}" class="logo">EduPlatform</a>
        </div>

        <nav class="course-sidebar-nav">
            {% for module in modules %}
            <div x-data="{ open: false }" class="module-block">
                <button class="module-toggle" @click="open = !open">
                    {{ module.title }}
                    <span x-text="open ? '−' : '+'"></span>
                </button>

                <ul class="lesson-list" x-show="open" x-collapse>
                    {% for lesson in module.lesson_list %}
                    <li>
                        <a
    @click.stop
    hx-get="{% url 'core:partial_lesson_detail' lesson.id %}"
    hx-target="#main-content"
    hx-swap="innerHTML"
    hx-indicator="#loading-indicator"
    href="javascript:void(0)"
    class="lesson-link {% if lesson.id in completed_lessons %}completed{% endif %}"
>

                    </li>
                    {% endfor %}

                    {% if module.test_list %}
                    <li class="test-link">
                        <a
    @click.stop
    hx-get="{% url 'core:partial_test_module' module.id %}"
    hx-target="#main-content"
    hx-swap="innerHTML"
    hx-indicator="#loading-indicator"
    href="javascript:void(0)"
    class="lesson-link"
>

                    </li>
                    {% endif %}
                </ul>
            </div>
            {% endfor %}
        </nav>
    </aside>

    <!-- ПРАВАЯ ПАНЕЛЬ -->
    <main class="course-content" id="main-content">
        <div class="welcome-card">
            <h2>Готов учиться?</h2>
            <p>Выбери урок слева, чтобы начать!</p>
            <div class="progress-bar">
                <div class="progress-fill" style="width: {{ progress_percentage }}%"></div>
            </div>
            <p>Прогресс: {{ progress_percentage }}%</p>
        </div>
    </main>
</div>

<!-- Индикатор загрузки HTMX -->
<div id="loading-indicator"
     style="display:none; position:fixed; top:20px; right:20px; padding:8px 14px;
            background:#333; color:white; border-radius:6px; z-index:9999;">
  Загрузка...
</div>

<script>
document.body.addEventListener('htmx:send', function() {
    document.getElementById('loading-indicator').style.display = 'block';
});
document.body.addEventListener('htmx:afterSwap', function() {
    document.getElementById('loading-indicator').style.display = 'none';
});
document.body.addEventListener('htmx:responseError', function(e) {
    document.getElementById('loading-indicator').style.display = 'none';
    document.getElementById('main-content').innerHTML =
      '<div class="error-card" style="padding:30px;text-align:center;color:red;">Ошибка загрузки: ' +
      e.detail.xhr.status + '</div>';
});
</script>
{% endblock %}
