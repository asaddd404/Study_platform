{% extends 'core/base.html' %}
{% load static %}

{% block content %}
<div class="container" style="padding-top: 40px; padding-bottom: 40px; max-width: 900px; margin: auto;">
    <div class="row">
        <div class="col-md-10 offset-md-1">
            
            <div class="card card-body mb-4">
                <h2>Настройки теста: {{ test.title }}</h2>
                <p class="text-muted">Модуль: {{ test.module.title }}</p>
                <form method="post">
                    {% csrf_token %}
                    {{ test_form.as_p }}
                    <button type="submit" name="submit_test_form" class="btn btn-primary mt-2">Сохранить настройки теста</button>
                </form>
            </div>

            <div class="card card-body mb-4">
                <h3>Вопросы теста ({{ questions.count }})</h3>
                <div id="questions-list">
                    {% for q in questions %}
                        <div class="card card-body mb-3">
                            <p><strong>Вопрос:</strong> {{ q.text|linebreaksbr }}</p>
                            
                            {% if q.question_type == 'choice' %}
                                <ul style="list-style-type: lower-alpha; margin-left: 20px;">
                                    {% if q.option_a %}<li>{{ q.option_a }}</li>{% endif %}
                                    {% if q.option_b %}<li>{{ q.option_b }}</li>{% endif %}
                                    {% if q.option_c %}<li>{{ q.option_c }}</li>{% endif %}
                                    {% if q.option_d %}<li>{{ q.option_d }}</li>{% endif %}
                                </ul>
                                <p><strong>Правильный ответ:</strong> <code>{{ q.correct_answer }}</code></p>
                            {% else %}
                                <p><strong>Правильный ответ:</strong> <code>{{ q.correct_answer }}</code></p>
                            {% endif %}
                            
                            <p><strong>Балл:</strong> {{ q.max_score }}</p>
                            <div>
                                <a href="{% url 'core:teacher_question_update' q.id %}" class="btn btn-sm btn-outline-primary mb-2">Редактировать</a>
                                <a href="{% url 'core:teacher_question_delete' q.id %}" class="btn btn-sm btn-outline-danger mb-2">Удалить</a>
                            </div>
                        </div>
                    {% empty %}
                        <p>Вопросов к этому тесту пока нет.</p>
                    {% endfor %}
                </div>
            </div>

            <div class="card card-body">
                <h3>Добавить новый вопрос</h3>
                <form method="post" id="add-question-form">
                    {% csrf_token %}
                    
                    <p>{{ question_form.text.label_tag }} {{ question_form.text }}</p>
                    <p>{{ question_form.question_type.label_tag }} {{ question_form.question_type }}</p>

                    <div id="choice-fields-container" style="display: none;">
                        <p>{{ question_form.option_a.label_tag }} {{ question_form.option_a }}</p>
                        <p>{{ question_form.option_b.label_tag }} {{ question_form.option_b }}</p>
                        <p>{{ question_form.option_c.label_tag }} {{ question_form.option_c }}</p>
                        <p>{{ question_form.option_d.label_tag }} {{ question_form.option_d }}</p>
                    </div>

                    <p>
                        {{ question_form.correct_answer.label_tag }} {{ question_form.correct_answer }}
                        <small style="color: #666; font-size: 0.8rem; display: block; margin-top: 5px;" id="correct-answer-help">
                           (Подсказка...)
                        </small>
                    </p>
                    <p>{{ question_form.max_score.label_tag }} {{ question_form.max_score }}</p>
                    
                    <button type="submit" name="submit_question_form" class="btn btn-success mt-2">Добавить вопрос</button>
                </form>
            </div>
            
            <a href="{% url 'core:profile' %}" class="btn btn-secondary" style="margin-top: 20px;">Назад в профиль</a>

        </div>
    </div>
</div>
{% endblock %}


{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const questionTypeSelect = document.getElementById('id_question_type_select');
    if (!questionTypeSelect) return; // На случай, если элемента нет
    
    const choiceFieldsContainer = document.getElementById('choice-fields-container');
    const helpText = document.getElementById('correct-answer-help');

    function toggleFields() {
        if (questionTypeSelect.value === 'choice') {
            choiceFieldsContainer.style.display = 'block';
            helpText.textContent = '(Введите букву правильного варианта, например: a, b, c или d)';
        } else { 
            choiceFieldsContainer.style.display = 'none';
            helpText.textContent = '(Введите точный текстовый ответ)';
        }
    }
    
    toggleFields();
    questionTypeSelect.addEventListener('change', toggleFields);
});
</script>
{% endblock %}