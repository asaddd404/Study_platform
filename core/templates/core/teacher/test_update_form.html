{% extends 'core/base.html' %}
{% load static %}
{% load i18n %} {% block content %}
<div class="container" style="padding-top: 40px; padding-bottom: 40px; max-width: 900px; margin: auto;">
    <div class="row">
        <div class="col-md-10 offset-md-1">
            
            <div class="card card-body mb-4">
                <h2>Настройки теста: {{ test.title }}</h2>
                <p class="text-muted">Модуль: {{ test.module.title }}</p>
                <form method="post">
                    {% csrf_token %}
                    {{ test_form.as_p }}
                    <button type="submit" name="submit_test_form" class="btn btn-primary mt-2">Сохранить настройки теста</button>
                </form>
            </div>

            <div class="card card-body mb-4">
                <h3>Вопросы теста ({{ questions.count }})</h3>
                <div id="questions-list">
                    {% for q in questions %}
                        <div class="card card-body mb-3">
                            <p><strong>Вопрос:</strong> {{ q.text|linebreaksbr }}</p>
                            
                            {% if q.question_type == 'choice' %}
                                <ul style="list-style-type: lower-alpha; margin-left: 20px;">
                                    {% if q.option_a %}<li>{{ q.option_a }}</li>{% endif %}
                                    {% if q.option_b %}<li>{{ q.option_b }}</li>{% endif %}
                                    {% if q.option_c %}<li>{{ q.option_c }}</li>{% endif %}
                                    {% if q.option_d %}<li>{{ q.option_d }}</li>{% endif %}
                                </ul>
                                <p><strong>Правильный ответ:</strong> <code>{{ q.correct_answer }}</code></p>
                            {% else %}
                                {% endif %}
                            
                            <p><strong>Балл:</strong> {{ q.max_score }}</p>
                            <div>
                                <a href="{% url 'core:teacher_question_update' q.id %}" class="btn btn-sm btn-outline-primary mb-2">Редактировать</a>
                                <a href="{% url 'core:teacher_question_delete' q.id %}" class="btn btn-sm btn-outline-danger mb-2">Удалить</a>
                            </div>
                        </div>
                    {% empty %}
                        <p>Вопросов к этому тесту пока нет.</p>
                    {% endfor %}
                </div>
            </div>

            <div class="card card-body">
                <h3>Добавить новый вопрос</h3>
                
                <form method="post" id="add-question-form">
                    {% csrf_token %}
                    
                    {{ question_form.as_p }}
                    
                    <button type="submit" name="submit_question_form" class="btn btn-success mt-2">Добавить вопрос</button>
                </form>
                </div>
            
            <a href="{% url 'core:profile' %}" class="btn btn-secondary" style="margin-top: 20px;">Назад в профиль</a>

        </div>
    </div>
</div>
{% endblock %}


{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // 1. Находим селектор (мы задали ему id='id_question_type' в forms.py)
    const questionTypeSelect = document.getElementById('id_question_type'); 
    if (!questionTypeSelect) return; 

    // 2. Находим <p> теги, которые Django создал вокруг полей
    // Это самый надежный способ
    const optionA = document.querySelector('label[for="id_option_a"]').closest('p');
    const optionB = document.querySelector('label[for="id_option_b"]').closest('p');
    const optionC = document.querySelector('label[for="id_option_c"]').closest('p');
    const optionD = document.querySelector('label[for="id_option_d"]').closest('p');
    const correctAnswer = document.querySelector('label[for="id_correct_answer"]').closest('p');

    // 3. Собираем их в массив
    const choiceFields = [optionA, optionB, optionC, optionD, correctAnswer];

    function toggleFields() {
        // 'choice' - это значение из <option value="choice">
        if (questionTypeSelect.value === 'choice') {
            choiceFields.forEach(field => {
                if(field) field.style.display = 'block';
            });
        } else {
            // 'open_ended' (или любой другой тип)
            choiceFields.forEach(field => {
                if(field) field.style.display = 'none';
            });
        }
    }
    
    // 4. Вызываем при загрузке и при изменении
    toggleFields();
    questionTypeSelect.addEventListener('change', toggleFields);
});
</script>
{% endblock %}