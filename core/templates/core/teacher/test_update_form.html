{% extends 'core/base.html' %}
{% load static %}
{% load i18n %} {% block content %}
<div class="container" style="padding-top: 40px; padding-bottom: 40px; max-width: 900px; margin: auto;">
    <div class="row">
        <div class="col-md-10 offset-md-1">
            
            <div class="card card-body mb-4">
                <h2>Настройки теста: {{ test.title }}</h2>
                <p class="text-muted">Модуль: {{ test.module.title }}</p>
                <form method="post">
                    {% csrf_token %}
                    {{ test_form.as_p }}
                    <button type="submit" name="submit_test_form" class="btn btn-primary mt-2">Сохранить настройки теста</button>
                </form>
            </div>

            <div class="card card-body mb-4">
                <h3>Вопросы теста ({{ questions.count }})</h3>
                <div id="questions-list">
                    {% for q in questions %}
                        <div class="card card-body mb-3">
                            <p><strong>Вопрос:</strong> {{ q.text|linebreaksbr }}</p>
                            
                            {% if q.question_type == 'choice' %}
                                <ul style="list-style-type: lower-alpha; margin-left: 20px;">
                                    {% if q.option_a %}<li>{{ q.option_a }}</li>{% endif %}
                                    {% if q.option_b %}<li>{{ q.option_b }}</li>{% endif %}
                                    {% if q.option_c %}<li>{{ q.option_c }}</li>{% endif %}
                                    {% if q.option_d %}<li>{{ q.option_d }}</li>{% endif %}
                                </ul>
                                <p><strong>Правильный ответ:</strong> <code>{{ q.correct_answer }}</code></p>
                            {% else %}
                                {% endif %}
                            
                            <p><strong>Балл:</strong> {{ q.max_score }}</p>
                            <div>
                                <a href="{% url 'core:teacher_question_update' q.id %}" class="btn btn-sm btn-outline-primary mb-2">Редактировать</a>
                                <a href="{% url 'core:teacher_question_delete' q.id %}" class="btn btn-sm btn-outline-danger mb-2">Удалить</a>
                            </div>
                        </div>
                    {% empty %}
                        <p>Вопросов к этому тесту пока нет.</p>
                    {% endfor %}
                </div>
            </div>

            <div class="card card-body">
                <h3>Добавить новый вопрос</h3>
                
                <form method="post" id="add-question-form">
                    {% csrf_token %}
                    
                    {{ question_form.as_p }}
                    
                    <button type="submit" name="submit_question_form" class="btn btn-success mt-2">Добавить вопрос</button>
                </form>
                </div>
            
            <a href="{% url 'core:profile' %}" class="btn btn-secondary" style="margin-top: 20px;">Назад в профиль</a>

        </div>
    </div>
</div>
{% endblock %}
{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const questionTypeSelect = document.getElementById('id_question_type');
    const correctAnswerP = document.querySelector('label[for="id_correct_answer"]').closest('p');
    const hiddenInput = document.getElementById('id_correct_answer');

    if (!questionTypeSelect || !correctAnswerP || !hiddenInput) {
        console.error('Не найдены элементы формы вопроса');
        return;
    }

    // Создаём <select>
    const select = document.createElement('select');
    select.name = 'correct_answer';  // Имя должно совпадать с полем формы
    select.className = 'form-input';
    select.required = true;
    select.style.width = '100%';
    select.style.marginTop = '8px';

    // Контейнер для <select>
    const selectContainer = document.createElement('div');
    selectContainer.id = 'correct-answer-select-container';
    selectContainer.appendChild(select);
    selectContainer.style.display = 'none';

    // Вставляем после <p>
    correctAnswerP.parentNode.insertBefore(selectContainer, correctAnswerP.nextSibling);

    function updateSelect() {
        select.innerHTML = '<option value="">— Выберите правильный ответ —</option>';

        const optionInputs = [
            { id: 'id_option_a', label: 'A' },
            { id: 'id_option_b', label: 'B' },
            { id: 'id_option_c', label: 'C' },
            { id: 'id_option_d', label: 'D' },
        ];

        optionInputs.forEach(opt => {
            const input = document.getElementById(opt.id);
            if (input && input.value.trim()) {
                const option = new Option(`${opt.label}: ${input.value.trim()}`, input.value.trim());
                select.add(option);
            }
        });

        // Восстанавливаем выбранное значение
        if (hiddenInput.value) {
            select.value = hiddenInput.value;
        }
    }

    function toggleSelect() {
        if (questionTypeSelect.value === 'choice') {
            updateSelect();
            selectContainer.style.display = 'block';
            correctAnswerP.style.display = 'none';  // Скрываем оригинальное поле
        } else {
            selectContainer.style.display = 'none';
            correctAnswerP.style.display = 'block';
        }
    }

    // Инициализация
    toggleSelect();

    // События
    questionTypeSelect.addEventListener('change', toggleSelect);

    ['id_option_a', 'id_option_b', 'id_option_c', 'id_option_d'].forEach(id => {
        const input = document.getElementById(id);
        if (input) {
            input.addEventListener('input', () => {
                if (questionTypeSelect.value === 'choice') {
                    updateSelect();
                }
            });
        }
    });

    // Перед отправкой — копируем в скрытое поле
    const form = document.getElementById('add-question-form');
    form.addEventListener('submit', function(e) {
        hiddenInput.value = select.value;
    });
});
</script>
{% endblock %}